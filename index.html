<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹åŠ¿è¯†åˆ« - è®­ç»ƒæ¨¡å¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
            color: #fff;
        }

        /* å³ä¸Šè§’æ‘„åƒå¤´å°çª— */
        .webcam-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 320px;
            height: 240px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,0.6);
            z-index: 1000;
            background: #000;
            border: 2px solid rgba(255,255,255,0.1);
        }

        #webcam {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
            pointer-events: none;
        }

        .gesture-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            padding: 6px 10px;
            font-size: 12px;
            text-align: center;
            z-index: 10;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-container {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            margin-top: 20px;
        }

        /* å·¦ä¾§ï¼šè®­ç»ƒæŒ‰é’®åŒº */
        .training-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .panel-title {
            font-size: 18px;
            margin-bottom: 20px;
            text-align: center;
            color: #aaa;
        }

        .training-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .train-btn {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255,255,255,0.1);
            color: #fff;
            position: relative;
        }

        .train-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }

        .train-btn.active {
            background: rgba(76, 175, 80, 0.5);
            border: 2px solid #4CAF50;
        }

        .train-btn .sample-count {
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 10px;
            background: rgba(0,0,0,0.5);
            padding: 2px 4px;
            border-radius: 4px;
        }

        /* è¯†åˆ«æŒ‰é’® */
        .recognize-btn {
            margin-top: 20px;
            width: 100%;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .recognize-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .recognize-btn.recording {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: pulse 1s infinite;
        }

        .clear-btn {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .clear-btn, .export-btn {
            flex: 1;
            padding: 10px;
            font-size: 13px;
            font-weight: bold;
            color: #fff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .export-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .export-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
        }

        .clear-btn {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .clear-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(250, 112, 154, 0.4);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* å³ä¾§ï¼šæ•°å­—å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ */
        .number-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .number-display {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
            background: #000;
            border: 3px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .number-display.active {
            border-color: rgba(255, 107, 157, 0.5);
            transform: scale(1.05);
        }

        .number-title {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0,0,0,0.7);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 18px;
            z-index: 10;
            backdrop-filter: blur(4px);
        }

        #numberImage {
            width: 500px;
            height: 500px;
            object-fit: contain;
            background: #000;
            display: none;
        }

        #numberImage.visible {
            display: block;
        }

        .number-placeholder {
            width: 500px;
            height: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.3);
            font-size: 96px;
            font-weight: bold;
        }

        .number-placeholder.hidden {
            display: none;
        }

        .number-placeholder span:last-child {
            font-size: 18px;
            margin-top: 15px;
        }

        .status {
            padding: 15px 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            font-size: 18px;
            text-align: center;
            backdrop-filter: blur(4px);
            min-width: 300px;
        }

        .status.number {
            background: rgba(255, 107, 157, 0.2);
            color: #ff6b9d;
            font-size: 48px;
            font-weight: bold;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 12px 24px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        button.start-btn {
            background: #4CAF50;
            color: white;
        }

        button.stop-btn {
            background: #f44336;
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .training-status {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- å³ä¸Šè§’æ‘„åƒå¤´å°çª— -->
    <div class="webcam-container">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
        <div class="gesture-info" id="gestureInfo">ç­‰å¾…å¯åŠ¨...</div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-container">
        <!-- å·¦ä¾§è®­ç»ƒé¢æ¿ -->
        <div class="training-panel">
            <div class="panel-title">ğŸ¯ è®­ç»ƒæ¨¡å¼ - ç‚¹å‡»æ•°å­—æŒ‰é’®å½•åˆ¶æ‰‹åŠ¿</div>
            <div class="training-buttons">
                <button class="train-btn" data-number="0">0<span class="sample-count">0</span></button>
                <button class="train-btn" data-number="1">1<span class="sample-count">0</span></button>
                <button class="train-btn" data-number="2">2<span class="sample-count">0</span></button>
                <button class="train-btn" data-number="3">3<span class="sample-count">0</span></button>
                <button class="train-btn" data-number="4">4<span class="sample-count">0</span></button>
                <button class="train-btn" data-number="5">5<span class="sample-count">0</span></button>
                <button class="train-btn" data-number="6">6<span class="sample-count">0</span></button>
                <button class="train-btn" data-number="7">7<span class="sample-count">0</span></button>
                <button class="train-btn" data-number="8">8<span class="sample-count">0</span></button>
                <button class="train-btn" data-number="9">9<span class="sample-count">0</span></button>
            </div>
            <button class="recognize-btn" id="recognizeBtn">ğŸ” æŒ‰ä½è¯†åˆ«æ‰‹åŠ¿</button>
            <div class="training-status" id="trainingStatus">å·²å½•åˆ¶: 0/10 ä¸ªæ•°å­—</div>
            <div class="action-buttons">
                <button class="export-btn" id="exportBtn">ğŸ“¤ å¯¼å‡ºè®­ç»ƒæ•°æ®</button>
                <button class="clear-btn" id="clearBtn">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è®­ç»ƒæ•°æ®</button>
            </div>
        </div>

        <!-- å³ä¾§æ•°å­—å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="number-container">
            <div class="number-display" id="numberDisplay">
                <span class="number-title">æ•°å­—æ‰‹åŠ¿è¯†åˆ« (0-9)</span>
                <img id="numberImage" alt="æ•°å­—æ‰‹åŠ¿">
                <div class="number-placeholder" id="numberPlaceholder">
                    <span>?</span>
                    <span>å…ˆè®­ç»ƒï¼Œå†è¯†åˆ«</span>
                </div>
            </div>

            <div class="status" id="numberStatus">ç‚¹å‡»æ•°å­—æŒ‰é’®å½•åˆ¶æ‰‹åŠ¿æ ·æœ¬</div>
        </div>
    </div>

    <div class="controls">
        <button id="startBtn" class="start-btn">å¯åŠ¨æ‘„åƒå¤´</button>
        <button id="stopBtn" class="stop-btn" style="display:none;">åœæ­¢æ‘„åƒå¤´</button>
    </div>

    <!-- MediaPipe Hands åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const numberImage = document.getElementById('numberImage');
        const numberPlaceholder = document.getElementById('numberPlaceholder');
        const numberDisplay = document.getElementById('numberDisplay');
        const numberStatus = document.getElementById('numberStatus');
        const gestureInfo = document.getElementById('gestureInfo');
        const trainingStatus = document.getElementById('trainingStatus');
        const recognizeBtn = document.getElementById('recognizeBtn');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const trainBtns = document.querySelectorAll('.train-btn');

        // ==================== é¢„ç½®è®­ç»ƒæ•°æ® ====================
        // è®­ç»ƒå®Œæˆåï¼Œç‚¹å‡»"å¯¼å‡ºè®­ç»ƒæ•°æ®"ï¼Œå°†å¯¼å‡ºçš„ä»£ç ç²˜è´´åˆ°è¿™é‡Œ
        // è¿™æ ·ä¸‹æ¬¡æ‰“å¼€é¡µé¢å°±ä¸éœ€è¦é‡æ–°è®­ç»ƒäº†
        // ====================================================
const PRESET_DATA = {
    0: [[0.5172480199293478,0.20643113387879425,0.24769965095799046,0.25845306388574024,0.20712719336920385,1.1583871859054267,0.8919943175600451,0.7582026339013223,0.6506320464922819,0.605506426651492,0.9844775435579197,0.9917083574987476,0.9823963057962627,0.9761328320451882,0.9889796278719974,0.23476836053502528,0.26076211832520996,0.30101884165640075,0.36840686203513756],[0.5305927365988237,0.14569286426349695,0.19383260134257774,0.25747514076557637,0.20364991660950293,1.180295227415864,0.9249453214821038,0.8265279343477326,0.6829092108427045,0.6693154749598562,0.9664041970943575,0.989366468237715,0.9850037059121304,0.9757734675965947,0.9877115322041204,0.1675747107472349,0.20357334290919232,0.2932823142861138,0.32458953189075823],[0.54823019847023,0.2661217156716667,0.27992143401443675,0.2965974666446495,0.256454142247888,1.295421120706936,0.8880574179765133,0.7895907527424585,0.6629510170956714,0.5994520340450336,0.9896472983463491,0.9878017200500514,0.9820739523848393,0.9645670484357586,0.9816919508522299,0.35083759049994345,0.3454886073444435,0.3936712058030543,0.3982576128676613],[0.41574196005212355,0.3194585499519117,0.365359805695746,0.37468590161305526,0.322991894847571,1.1502520479574456,0.9353263255075109,0.8191565405282311,0.6340844334294884,0.5743616228006801,0.9679802908549698,0.9949950800104749,0.9763032742537241,0.9761613272267218,0.9987629281897268,0.4043894563749371,0.3864399989956981,0.4207308158135177,0.46586844658317617],[0.43540418206577924,0.3841218722904311,0.43633885985950954,0.416756197627266,0.37636861765634994,1.17187999812577,0.9619699443708934,0.8730469125014558,0.7480825622094135,0.6695517665313425,0.9678822116759875,0.9993801643336363,0.987526454580404,0.9780614581267659,0.997943888165708,0.4571606035373125,0.41513420447317395,0.3658670379008619,0.4198047493888861]],
    1: [[0.5328085195946154,0.8042663346716897,0.4718414064395398,0.4939543862182337,0.41448674130133584,1.2467789360007637,1.864548335876935,1.0143328708661286,0.6580596777752783,0.4745583457965607,0.9183405954973258,0.9423625329818507,0.9996659775011184,0.9866737715196223,0.9970513112250677,0.9999787798413106,0.4946802195073842,0.5635470969989512,0.5900938700257194],[0.25234378446138,0.9650275478930148,0.4521485477071233,0.5386608929025413,0.4198318119487083,0.9531839612536599,2.094856697239909,0.8371238277717211,0.5177013891119788,0.3778255912861429,0.9237365693373284,0.9573341165801585,0.9999281878797127,0.9665120000824263,0.8742524969700645,0.9998766296828646,0.5316621655369272,0.7064885891362965,0.7942046558291205],[0.44152877867725066,0.9216995843970781,0.17957118164871907,0.38794980232691517,0.29174562144354727,0.9821452018802999,2.0085886044215004,0.9213685202712146,0.5476799785510607,0.4816591034661834,0.9972788396176084,0.9989131335751781,0.9989536759822727,0.9584801867765195,0.9896920403861957,0.999897753594745,0.2120930260908892,0.5859271300442791,0.5905413559418174],[0.271391835516173,0.9137007805568182,0.47796345986281963,0.5739910757208185,0.4866056383123149,0.5787684110210244,1.9605663776538997,0.554797572979433,0.34710588702616074,0.27912534433148983,0.9957597703279555,0.9960432062659872,0.9966306122673559,0.9114077515678853,0.9351340344508147,0.9999420325719515,0.9663988296104773,0.9997134222960359,0.9950481814599236],[0.36616898582389235,0.880391202482827,0.32014231264193943,0.44299433257938686,0.3473959507177784,0.938228196976448,1.9479265124247889,0.7789141856537539,0.5195667688007338,0.45997695990176013,0.9880789073695064,0.9905372363659022,0.9972896344519984,0.9675434182191145,0.9097029150401501,0.9994086267148838,0.4470950989273338,0.714945656894082,0.7592166471704803]],
    2: [[0.362377976546937,0.8606568739827228,0.9098319100828748,0.16494542258585126,0.3028237063116425,0.7456258133901097,1.9034713945349484,1.9068979912419008,0.7635013911441239,0.4613451737224706,0.9840711511159884,0.9695724520018355,0.9996608665678423,0.9995738900639467,0.9679168593411038,0.9996585073787323,0.9998849800712714,0.25888187116434447,0.6808658704385911],[0.3958821942676536,0.8356733791429334,0.8914760752982459,0.10822969596836086,0.22368709081913635,0.8159820106276202,1.8690824014681502,1.8877814060343443,0.7979690473065039,0.5250490060845137,0.9730578875062148,0.9695630465039958,0.9999246453091397,0.9985723963510857,0.9844673185436662,0.9993978684167121,0.9999555563545968,0.17510852492131457,0.545018980248345],[0.38290116728582263,0.8475073131016725,0.8843007434795341,0.284577948470783,0.3831857639270693,0.7765347049902434,1.8823067322475244,1.8822449214433499,0.6735737729250436,0.42455425219149867,0.9982606707388884,0.975577681971091,0.992189732753285,0.999779133112318,0.9585985016824687,0.9993189718121673,0.9991654471294609,0.41257571987295955,0.7957023166721031],[0.3348581411378574,0.8933048267020641,0.9087897748345278,0.3189595453971216,0.39972154108435487,0.689164900668419,1.9405562884932814,1.9067954333722443,0.5975066731174495,0.37136117403062774,0.9819746827925531,0.9669680243654301,0.997182142888496,0.9999040055163146,0.9571750473474474,0.9996849550371606,0.999940326325508,0.5290584091126816,0.8906981759559193],[0.42062093101373915,0.8259975143245042,0.9300110972831577,0.2184454175167512,0.2363131617062033,0.9643698372330314,1.8663186742476934,1.9261730234571803,0.7304453315956027,0.6180908590317467,0.9799175288618438,0.9716617316830578,0.9942961302662924,0.9973872204703486,0.9633364747665054,0.9984920582589712,0.9999993987094753,0.3465431210807649,0.5205441966314874]],
    3: [[0.48853065600905804,0.26461907054921147,0.9394984501535417,0.8713260237590423,0.6282240159972048,1.2252220522883137,1.005671889324779,1.9284494295369405,1.795080069811023,1.4501779833797939,0.999352375761314,0.9462195574214347,0.9853288401381397,0.9604465333894483,0.9529645565480481,0.3669357030982815,0.9961057558799719,0.9867871408429838,0.9923432092212123],[0.4230505942148414,0.1413461796072847,0.7826100782280546,0.7644862636829254,0.586703993184855,1.1182093200898655,1.0327948587132758,1.7816202133899057,1.6826104777328352,1.3878583480365831,0.9989806417146486,0.9618422778967356,0.990516079060193,0.964216560859402,0.9277519881208688,0.23749347190060296,0.9978534528041467,0.9944412507212832,0.9978573567921483],[0.4066706874526717,0.23003292930424307,0.8754098128322029,0.8400340041858939,0.6590501668912123,1.084770342780335,0.9354945887018694,1.8708425891008043,1.7789931445961555,1.493868867994601,0.9984895445556327,0.9411129810587906,0.9892476671084549,0.96912676186752,0.9896410025170046,0.3342172704864017,0.9971539482453012,0.9903549282789678,0.9950260169262833],[0.4285544936338668,0.11322476490861935,0.7966031804575413,0.7802660915990347,0.6161974652700888,1.0241869138542263,0.9552913396845336,1.796580021709267,1.7228877523587505,1.4568314389365495,0.9985038175061902,0.9615471516274126,0.9942968248197951,0.97124233938089,0.9381057108724081,0.18455006396599902,0.9997648660047006,0.9979638655613889,0.9985486949881704],[0.4340056894609954,0.09309993493234782,0.8093633473181782,0.7751603336529208,0.6119550229880526,1.0358213460568206,0.9876977679176416,1.8093622053733682,1.7199752651596967,1.4563230302085803,0.998107186382136,0.9664047443732339,0.9947431111160087,0.972194545855486,0.9372182172930151,0.15923947956614287,0.9998898341738635,0.9980236956414926,0.9989422844695829]],
    4: [[0.37214512795246735,0.8007783594262661,0.8188297462325188,0.7237473379349247,0.5428382200561312,0.791914534378093,1.8250402386663196,1.8164159296011766,1.6262911668655868,1.2968174661554492,0.9632060108140797,0.9747817282375001,0.9908631658221314,0.963020781019841,0.8740426004556904,0.9994218374494275,0.9994484093820353,0.9994029277488152,0.9992127712858632],[0.3497870203738773,0.8125842858652453,0.8391125578408153,0.7332179128948707,0.5436319418763796,0.7319069265404495,1.8308273885038329,1.8368077010128436,1.6369062431475485,1.2960829730830434,0.9728145819114994,0.9735976766318555,0.9914959537748395,0.9641033774994773,0.7699219928537872,0.9992138604216693,0.9998135153586206,0.9986770296498483,0.9977619724861042],[0.3323537059876694,0.7947339550660334,0.8352634817967864,0.7472866310643194,0.5520551526039644,0.7615417070426826,1.7979888867326406,1.8341510729943944,1.6643715337493288,1.3320972185562028,0.9805065977831111,0.9773040188641495,0.993848133673692,0.9732140101861896,0.7856576431423947,0.9993249030358462,0.9999988593229459,0.997504220308637,0.9985561271337379],[0.36320431435980666,0.7940079001903976,0.8371620327854161,0.7592741846741794,0.5556450196797118,0.8349080273194038,1.801599893452073,1.8350705196968926,1.674340131560729,1.332832993656389,0.9874145887436807,0.977886277128929,0.994122399548977,0.976933096737007,0.8676321253333771,0.9992396217790989,0.9999639699825474,0.9982428237376887,0.9985738356407824],[0.36460815585937495,0.7983722018519206,0.8390541486537284,0.7547875703256994,0.5529602936435393,0.8183786624378206,1.8073988700539807,1.8366828365320862,1.6695891747692826,1.3282923931804624,0.9833298107000009,0.9765597720379213,0.9939695427084325,0.9750444622244596,0.860014146017425,0.99905053085081,0.9998802738970585,0.998592716431961,0.9988657928906316]],
    5: [[0.5690198743326115,0.8283937078348448,0.8378772238938468,0.7581852181640977,0.5535844009478766,1.3345854529586847,1.871692401394561,1.8315540671823314,1.6588894447058251,1.312291120067254,0.9332882347746189,0.9741372489189404,0.9913529503015964,0.9605713183720656,0.9967962632891809,0.9988253968931753,0.9989151778763917,0.9999761906829742,0.9984819252765963],[0.5792620356983603,0.879432307060212,0.8830881358326397,0.7933145892093381,0.5949285134334649,1.366605385998488,1.9317256227558866,1.8744544528489462,1.6824642930828155,1.3304487068489017,0.9164351042072673,0.9691306747079587,0.9892259408448616,0.9524625616048366,0.9952989900826071,0.9984424695272448,0.9980936008132875,0.9998618744180813,0.9990666682609032],[0.535365056827358,0.8441074965396564,0.9049220693188612,0.8345660893246697,0.6208230378239179,1.2301854563520207,1.8511050153074144,1.9024006681179513,1.7630563734934852,1.4290000719172355,0.928659520168283,0.9766440489576873,0.995015047878365,0.9749327911592858,0.9966214061195225,0.9995259366739628,0.9999802067286252,0.9989475851435424,0.9988987865040115],[0.5187390574014002,0.8158660785747356,0.9083246506024863,0.8283692447410784,0.6568156859228443,1.1790243683416994,1.7981368757615033,1.9079903353790248,1.7802795576522947,1.5104874544767806,0.9410532623525052,0.9767430356731948,0.9939903266196516,0.9737599217031235,0.9986455904797946,0.9991461384651502,0.9999724812690465,0.998949631329488,0.9990276958035886],[0.5305539956913591,0.8125095994510247,0.8967610553006723,0.8225489329485961,0.6440546452707431,1.2038539815672986,1.8038837514198511,1.8963671313198014,1.7664365517333136,1.4810674324518003,0.9429806107435934,0.9780853018399871,0.994301354761138,0.9727541088978915,0.9979865619642205,0.9994049406689393,0.9999269870820765,0.9977925434608371,0.9985901489994213]],
    6: [[0.6506163225160914,0.3278363665400922,0.47039773165740384,0.3586420060868061,0.7526545671486917,1.471474614486936,0.7333765099309127,0.5449827789958601,0.6138815274593086,1.6631594381479198,0.9897734121112383,0.9882226121191645,0.9757996120825762,0.9571768206627058,0.999888934898406,0.4467152706625172,0.5980324867432797,0.44337761959645294,0.9952025294381578],[0.6665461075635455,0.32365771388241704,0.45975119859553876,0.3598165882864327,0.7322863562395828,1.4713601721711889,0.715856132783818,0.5499611656404348,0.6134551334196837,1.6471506153353075,0.9827575228785289,0.9907247961147954,0.979915386962817,0.9603820525584152,0.999989444564046,0.4211447660930546,0.5798835544709618,0.43965370626323064,0.9945933335838641],[0.6806001489642644,0.3237546685035098,0.4418276628573067,0.3394488498950724,0.7471747307879136,1.4918825418311663,0.7173855914568366,0.5670195842555557,0.6349996269545005,1.666521058389611,0.9845386140848198,0.9890003419660928,0.9801476464492015,0.963501322827565,0.9999953223320913,0.39741214195090524,0.5491797661377971,0.40689676676918934,0.9963080707748574],[0.6634435060265111,0.34114969277304014,0.44665607772966004,0.3251366867896274,0.7254749805375743,1.450324851299204,0.7051011806139593,0.5560943977361348,0.6368449486934415,1.6320832414669062,0.9801252541159312,0.9892550233381551,0.9847779233238638,0.9616732313253205,0.9999860416647747,0.4459872742602995,0.5789358954660223,0.4156866016710073,0.9991858136245982],[0.6508444335803248,0.3561548949324365,0.46654112782776475,0.34385072188866883,0.7162539418528795,1.4437790669612118,0.6907613031395161,0.5379888707963156,0.6191688711814843,1.622321744485493,0.9810358136215784,0.9894621086016977,0.9817599273774168,0.9607518663531753,0.9999543018630277,0.46756736490309136,0.6100042918633132,0.4439835500555302,0.9989375413376669]],
    7: [[0.4595267762895849,0.27102577772301806,0.26973965497205277,0.3990795019565449,0.333871518888377,1.112276920119933,1.193319376934514,1.0275118562178482,0.5974017363398243,0.5378693437443036,0.998834973712278,0.9967832906039527,0.9860648415450994,0.9540171654005051,0.9873128746992754,0.6220170040099349,0.40833041670046555,0.5925965705594884,0.7102149085138365],[0.3755491537117698,0.55646535059734,0.662650788881035,0.5712920784730506,0.41239971166146505,1.0189587577496424,1.0321491210283795,0.7358696075392576,0.3861640798387107,0.3206574095798347,0.9999465713354412,0.9999713816555164,0.923184075951606,0.8788701077122453,0.9987960111377464,0.8910594067951261,0.859588394989172,0.8409827618958848,0.8765715795853489],[0.3741918412644658,0.6919775244763415,0.7735375214207425,0.6409957374626091,0.4523521478761218,1.0124282852627216,0.900218457780795,0.6835160692690322,0.3378086945337843,0.24457920061488128,0.9938516900701239,0.9993986881459849,0.9573039322103603,0.8619760271796644,0.999955780724517,0.9078460955395811,0.9328684932884294,0.8981081423995783,0.9293003280520686],[0.5006660185306019,0.16378067028017282,0.10496916683867447,0.20594254789966024,0.1708089050996844,1.0971729861830688,1.211796805856978,1.0980401471907713,0.6908616638415401,0.6237031292353883,0.9880161490083,0.9873964029657375,0.995382169246414,0.9746777518719407,0.9328013631884414,0.3926325553734995,0.15374310068059016,0.28224858576892736,0.3374487413005548],[0.3966485539191505,0.06804303084010704,0.2053905191311153,0.36409136373556955,0.27931459048261026,0.8829107988826341,1.0318056269163354,0.8262806901521811,0.5605032944671661,0.5429401133255346,0.9989182667177042,0.9889252725813876,0.9857417706886861,0.9663559547301971,0.9801910150202122,0.13247776618728405,0.27781677173186514,0.5910634158904298,0.7083926339384502]],
    8: [[0.6097612573001636,0.8556695623466171,0.45671841915626576,0.4291660750110492,0.37148711032059195,1.4609313088623606,1.928025846914716,0.5982929289852941,0.46986639466456326,0.4428959752167119,0.7642001335810482,0.9724492692993862,0.9474821513556251,0.9162380528578047,0.9954096749154566,0.9965734434592842,0.8180439219546723,0.8861713178291445,0.8577325472185905],[0.6661168903374485,0.8761715823604842,0.3191290694189154,0.30711698028756174,0.2657637936637229,1.4991728612865407,1.9687191554251204,0.7186621807902275,0.5772066972017127,0.5251514585782386,0.8069157825666076,0.9759124156613783,0.9590602811735658,0.9053228510201401,0.9970845418826026,0.9956720313022386,0.581965737451265,0.7085647592221613,0.6620878743593347],[0.594785040973965,0.8251456799970924,0.5195786610909422,0.4668182471603037,0.3698795086559668,1.4562071670773116,1.9018390505109342,0.5492861053511792,0.4313918340748642,0.39420892015514297,0.7964995301747799,0.9695669861145406,0.9545752164172852,0.9090775039836275,0.9945311422751782,0.9998998543311044,0.792095108972405,0.8211387400074502,0.8348433586567744],[0.6272248033877061,0.9172460068284735,0.38184436804689664,0.35575621803498236,0.2985345270519602,1.485359731861567,2.0122931863007287,0.6580014640253375,0.5270569928884687,0.5101900535777231,0.774531232974202,0.9732194556517857,0.9461808062109199,0.897399815881624,0.9954986559554628,0.9965395197372302,0.6509828985711671,0.7679808022604675,0.7044132273868569],[0.5819328418787255,0.8431776139203362,0.48129010695503505,0.43742937165639634,0.3638486066333346,1.455121926937391,1.9288709601401752,0.5774908065025024,0.46343544302657913,0.4198683824814767,0.8125638423322071,0.9747496468047743,0.9624527588801891,0.9341873345937048,0.9951157458976989,0.9988871724576203,0.7565792107021122,0.8087954909844429,0.7873392537070207]],
    9: [[0.488609293221761,0.7510006176799473,0.44392499426804044,0.3260785876258634,0.2252609688770707,1.3477016968140398,1.8715555914748396,1.0319572714673348,0.7644631649625586,0.5955861776581974,0.9496581211952881,0.9757398866136144,0.9973817688837239,0.9858143527828435,0.968520130623641,0.898951536428485,0.5192942243174644,0.39527898943671763,0.3458583661103311],[0.44904757099824155,0.70069319590019,0.3722478496922202,0.3068840338752886,0.22831606132367196,1.3178296999356023,1.7996696337623657,0.9928346231486331,0.7619431591920532,0.575014144751154,0.9616869656635009,0.9874919260931676,0.9968783493586056,0.9840131740297533,0.959723227236251,0.9032027158670888,0.4515521677494934,0.38788040418083136,0.3615089422739809],[0.46740098508806,0.7733754934105752,0.44582713943293634,0.3269611210498965,0.2421559193086066,1.3294799324677284,1.8969627491875236,1.0428778582109273,0.7589839995529594,0.6054757874325025,0.9528246897252951,0.977116177124164,0.9962233953190717,0.9769032890953295,0.9517940596317832,0.9104775819611036,0.5154242546964128,0.3888400159466055,0.36409996869509914],[0.4699951858146857,0.7189270833124006,0.3753765682783014,0.3050417356854844,0.21538901878522598,1.3347050365458302,1.8108550090901085,0.9912556915679834,0.7509936460853073,0.5646953275461487,0.9650951022987229,0.9888420322598647,0.997632831477868,0.9888571155352812,0.9734174450392776,0.9120149021239755,0.4619618850115746,0.39030244860743907,0.35175872486814613],[0.12515285483790667,0.48748111468515065,0.5267870662641634,0.4750413706575278,0.3667335908782119,0.9229228914270009,1.594881492241891,0.7160654740194146,0.5017993120168986,0.27015347643848403,0.934730003020343,0.9824386156462214,0.9996074035062879,0.9987573406370106,0.46517474158431565,0.6615324618732447,0.7665716064752983,0.7882163279403447,0.796218478271669]]
};
        // è®­ç»ƒæ•°æ®ï¼šæ¯ä¸ªæ•°å­—å­˜å‚¨å¤šä¸ªæ‰‹åŠ¿æ ·æœ¬
        const trainingData = {
            0: [], 1: [], 2: [], 3: [], 4: [],
            5: [], 6: [], 7: [], 8: [], 9: []
        };

        // çŠ¶æ€
        let isRecognizing = false;
        let isCameraRunning = false;

        const numberImageFiles = ['0.png', '1.png', '2.png', '3.png', '4.png', '5.png', '6.png', '7.png', '8.png', '9.png'];

        // æœ¬åœ°å­˜å‚¨é”®å
        const STORAGE_KEY = 'gestureTrainingData';

        // æ•°æ®ç‰ˆæœ¬å·ï¼ˆå½“ç®—æ³•æ”¹å˜æ—¶éœ€è¦æ›´æ–°ï¼‰
        const DATA_VERSION = 2;

        // ä¿å­˜è®­ç»ƒæ•°æ®åˆ°localStorage
        function saveTrainingData() {
            const dataToSave = {
                version: DATA_VERSION,
                samples: {}
            };
            for (let num = 0; num <= 9; num++) {
                dataToSave.samples[num] = trainingData[num];
            }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
            console.log('è®­ç»ƒæ•°æ®å·²ä¿å­˜');
        }

        // ä»ä»£ç æˆ–localStorageåŠ è½½è®­ç»ƒæ•°æ®ï¼ˆä¼˜å…ˆä½¿ç”¨ä»£ç ä¸­çš„é¢„ç½®æ•°æ®ï¼‰
        function loadTrainingData() {
            // é¦–å…ˆå°è¯•ä»ä»£ç ä¸­çš„PRESET_DATAåŠ è½½
            if (PRESET_DATA && Object.keys(PRESET_DATA).length > 0) {
                try {
                    for (let num = 0; num <= 9; num++) {
                        if (PRESET_DATA[num] && Array.isArray(PRESET_DATA[num])) {
                            trainingData[num] = PRESET_DATA[num];
                        }
                    }
                    console.log('ä»ä»£ç åŠ è½½é¢„ç½®è®­ç»ƒæ•°æ®');

                    // æ›´æ–°UIæ˜¾ç¤ºæ ·æœ¬æ•°é‡
                    trainBtns.forEach(btn => {
                        const num = btn.dataset.number;
                        const countSpan = btn.querySelector('.sample-count');
                        countSpan.textContent = trainingData[num].length;
                    });
                    updateTrainingStatus();
                    return;
                } catch (e) {
                    console.error('åŠ è½½é¢„ç½®æ•°æ®å¤±è´¥:', e);
                }
            }

            // å¦‚æœæ²¡æœ‰é¢„ç½®æ•°æ®ï¼Œå°è¯•ä»localStorageåŠ è½½
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);

                    // æ£€æŸ¥æ•°æ®ç‰ˆæœ¬ï¼Œå¦‚æœä¸å…¼å®¹åˆ™æ¸…é™¤
                    if (!parsed.version || parsed.version !== DATA_VERSION) {
                        console.warn('æ•°æ®ç‰ˆæœ¬ä¸å…¼å®¹ï¼Œæ¸…é™¤æ—§æ•°æ®');
                        localStorage.removeItem(STORAGE_KEY);
                        return;
                    }

                    for (let num = 0; num <= 9; num++) {
                        if (parsed.samples[num] && Array.isArray(parsed.samples[num])) {
                            trainingData[num] = parsed.samples[num];
                        }
                    }
                    console.log('è®­ç»ƒæ•°æ®å·²åŠ è½½');

                    // æ›´æ–°UIæ˜¾ç¤ºæ ·æœ¬æ•°é‡
                    trainBtns.forEach(btn => {
                        const num = btn.dataset.number;
                        const countSpan = btn.querySelector('.sample-count');
                        countSpan.textContent = trainingData[num].length;
                    });
                    updateTrainingStatus();
                } catch (e) {
                    console.error('åŠ è½½è®­ç»ƒæ•°æ®å¤±è´¥:', e);
                }
            }
        }

        // æå–æ‰‹åŠ¿ç‰¹å¾ï¼ˆæ‰‹æŒ‡ä¼¸å±•ç¨‹åº¦ã€ç›¸å¯¹ä½ç½®ç­‰ï¼‰
        function extractFeatures(landmarks) {
            const features = [];

            // MediaPipe æ‰‹éƒ¨å…³é”®ç‚¹ç´¢å¼•:
            // 0: æ‰‹è…•
            // 1-4: æ‹‡æŒ‡ (æŒ‡æ ¹åˆ°æŒ‡å°–)
            // 5-8: é£ŸæŒ‡ (æŒ‡æ ¹åˆ°æŒ‡å°–)
            // 9-12: ä¸­æŒ‡
            // 13-16: æ— åæŒ‡
            // 17-20: å°æŒ‡

            // è®¡ç®—æ‰‹æŒå¤§å°ï¼ˆæ‰‹è…•åˆ°ä¸­æŒ‡æŒ‡æ ¹çš„è·ç¦»ä½œä¸ºåŸºå‡†ï¼‰
            const palmSize = distance(landmarks[0], landmarks[9]);

            // 1. æ¯ä¸ªæ‰‹æŒ‡çš„ä¼¸å±•ç¨‹åº¦ï¼ˆæŒ‡å°–åˆ°æŒ‡æ ¹çš„è·ç¦»ï¼Œå½’ä¸€åŒ–ï¼‰
            const fingerTips = [4, 8, 12, 16, 20]; // æŒ‡å°–
            const fingerBases = [2, 5, 9, 13, 17]; // æŒ‡æ ¹ï¼ˆè¿‘å…³èŠ‚ï¼‰
            for (let i = 0; i < 5; i++) {
                const tip = landmarks[fingerTips[i]];
                const base = landmarks[fingerBases[i]];
                const fingerLength = distance(tip, base) / palmSize;
                features.push(fingerLength);
            }

            // 2. æŒ‡å°–åˆ°æ‰‹è…•çš„è·ç¦»ï¼ˆè¡¨ç¤ºæ‰‹æŒ‡ä¼¸å±•æ–¹å‘ï¼‰
            for (let i = 0; i < 5; i++) {
                const tip = landmarks[fingerTips[i]];
                const wrist = landmarks[0];
                features.push(distance(tip, wrist) / palmSize);
            }

            // 3. æ‰‹æŒ‡ä¹‹é—´çš„è§’åº¦ï¼ˆä½¿ç”¨ç‚¹ç§¯ï¼‰
            // æ‹‡æŒ‡-é£ŸæŒ‡, é£ŸæŒ‡-ä¸­æŒ‡, ä¸­æŒ‡-æ— åæŒ‡, æ— åæŒ‡-å°æŒ‡
            const angles = [
                [4, 8, 0],   // æ‹‡æŒ‡å’Œé£ŸæŒ‡çš„å¤¹è§’
                [8, 12, 0],  // é£ŸæŒ‡å’Œä¸­æŒ‡
                [12, 16, 0], // ä¸­æŒ‡å’Œæ— åæŒ‡
                [16, 20, 0]  // æ— åæŒ‡å’Œå°æŒ‡
            ];

            for (const [i, j, centerIdx] of angles) {
                const center = landmarks[centerIdx];
                const v1 = normalizeVector(landmarks[i].x - center.x, landmarks[i].y - center.y);
                const v2 = normalizeVector(landmarks[j].x - center.x, landmarks[j].y - center.y);
                const dot = v1.x * v2.x + v1.y * v2.y;
                features.push(dot); // -1åˆ°1ä¹‹é—´ï¼Œ-1è¡¨ç¤ºåå‘ï¼Œ1è¡¨ç¤ºåŒå‘
            }

            // 4. æ‰‹æŒ‡çš„å¼¯æ›²ç¨‹åº¦ï¼ˆè¿œå…³èŠ‚åˆ°è¿‘å…³èŠ‚çš„è·ç¦»ï¼‰
            const fingerJoints = [
                [4, 3, 2],  // æ‹‡æŒ‡
                [8, 6, 5],  // é£ŸæŒ‡
                [12, 10, 9], // ä¸­æŒ‡
                [16, 14, 13], // æ— åæŒ‡
                [20, 18, 17]  // å°æŒ‡
            ];

            for (const [tip, mid, base] of fingerJoints) {
                const straightDist = distance(landmarks[tip], landmarks[base]) / palmSize;
                const midPointDist = (distance(landmarks[tip], landmarks[mid]) + distance(landmarks[mid], landmarks[base])) / palmSize;
                const bendness = straightDist / midPointDist; // 1è¡¨ç¤ºä¼¸ç›´ï¼Œ<1è¡¨ç¤ºå¼¯æ›²
                features.push(bendness);
            }

            return features;
        }

        // è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—ä¸¤ç‚¹è·ç¦»
        function distance(p1, p2) {
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
        }

        // è¾…åŠ©å‡½æ•°ï¼šå½’ä¸€åŒ–å‘é‡
        function normalizeVector(x, y) {
            const len = Math.sqrt(x * x + y * y);
            if (len === 0) return { x: 0, y: 0 };
            return { x: x / len, y: y / len };
        }

        // è®¡ç®—ä¸¤ä¸ªç‰¹å¾å‘é‡çš„ç›¸ä¼¼åº¦ï¼ˆåŠ æƒæ¬§æ°è·ç¦»ï¼‰
        function calculateSimilarity(features1, features2) {
            let totalDistance = 0;
            let totalWeight = 0;

            // ç»™ä¸åŒç‰¹å¾ç±»å‹ä¸åŒçš„æƒé‡
            // å‰5ä¸ªï¼šæ‰‹æŒ‡ä¼¸å±•ç¨‹åº¦ï¼ˆæƒé‡é«˜ï¼‰
            // ä¸­é—´5ä¸ªï¼šæŒ‡å°–åˆ°æ‰‹è…•è·ç¦»ï¼ˆæƒé‡é«˜ï¼‰
            // æ¥ä¸‹æ¥4ä¸ªï¼šæ‰‹æŒ‡è§’åº¦ï¼ˆæƒé‡ä¸­ï¼‰
            // æœ€å5ä¸ªï¼šå¼¯æ›²ç¨‹åº¦ï¼ˆæƒé‡é«˜ï¼‰
            for (let i = 0; i < features1.length; i++) {
                let weight = 1.0;
                if (i < 10) weight = 2.0; // æ‰‹æŒ‡ä¼¸å±•ç¨‹åº¦
                else if (i < 14) weight = 1.5; // è§’åº¦
                else weight = 2.0; // å¼¯æ›²ç¨‹åº¦

                const diff = features1[i] - features2[i];
                totalDistance += weight * diff * diff;
                totalWeight += weight;
            }

            return Math.sqrt(totalDistance / totalWeight);
        }

        // å½’ä¸€åŒ–æ‰‹åŠ¿æ ·æœ¬ï¼ˆæå–ç‰¹å¾å‘é‡ï¼‰
        function normalizeSample(landmarks) {
            return extractFeatures(landmarks);
        }

        // è¯†åˆ«å½“å‰æ‰‹åŠ¿ - å¸¦è°ƒè¯•ä¿¡æ¯
        function recognizeGesture(landmarks) {
            const normalizedSample = normalizeSample(landmarks);
            let bestNumber = -1;
            let bestScore = Infinity;
            const scores = [];

            // éå†æ‰€æœ‰å·²è®­ç»ƒçš„æ•°å­—
            for (let num = 0; num <= 9; num++) {
                if (trainingData[num].length === 0) continue;

                // è®¡ç®—ä¸è¯¥æ•°å­—æ‰€æœ‰æ ·æœ¬çš„å¹³å‡ç›¸ä¼¼åº¦
                let avgDistance = 0;
                for (const sample of trainingData[num]) {
                    avgDistance += calculateSimilarity(normalizedSample, sample);
                }
                avgDistance /= trainingData[num].length;
                scores[num] = avgDistance;

                console.log(`æ•°å­—${num}: è·ç¦»=${avgDistance.toFixed(4)}, æ ·æœ¬æ•°=${trainingData[num].length}`);

                if (avgDistance < bestScore) {
                    bestScore = avgDistance;
                    bestNumber = num;
                }
            }

            console.log(`æœ€ä½³åŒ¹é…: ${bestNumber}, è¯„åˆ†: ${bestScore.toFixed(4)}`);

            // é˜ˆå€¼è°ƒæ•´ï¼ˆæ–°ç‰¹å¾çš„è·ç¦»èŒƒå›´ä¸åŒï¼‰
            if (bestNumber !== -1) {
                if (bestScore < 0.15) {
                    return {
                        number: bestNumber,
                        message: `âœ… è¯†åˆ«ä¸º: ${bestNumber} (ç›¸ä¼¼åº¦: ${((1 - bestScore / 0.15) * 100).toFixed(0)}%)`
                    };
                } else if (bestScore < 0.3) {
                    return {
                        number: bestNumber,
                        message: `âš ï¸ å¯èƒ½æ˜¯: ${bestNumber} (ç›¸ä¼¼åº¦: ${((1 - bestScore / 0.3) * 100).toFixed(0)}%)`
                    };
                } else {
                    return {
                        number: -1,
                        message: `âŒ æœªåŒ¹é… (æœ€ä½³: ${bestNumber}, è·ç¦»: ${bestScore.toFixed(3)})`
                    };
                }
            }

            return {
                number: -1,
                message: 'âŒ è¯·å…ˆè®­ç»ƒæ•°å­—æ ·æœ¬ï¼'
            };
        }

        // æ›´æ–°è®­ç»ƒçŠ¶æ€æ˜¾ç¤º
        function updateTrainingStatus() {
            const trainedCount = Object.values(trainingData).filter(data => data.length > 0).length;
            const totalSamples = Object.values(trainingData).reduce((sum, data) => sum + data.length, 0);
            trainingStatus.textContent = `å·²å½•åˆ¶: ${trainedCount}/10 ä¸ªæ•°å­—, å…± ${totalSamples} ä¸ªæ ·æœ¬`;
        }

        // åˆå§‹åŒ– MediaPipe Hands
        const hands = new Hands({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });

        // é¡µé¢åŠ è½½æ—¶åŠ è½½è®­ç»ƒæ•°æ®
        loadTrainingData();
        hands.onResults(onResults);

        function onResults(results) {
            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (results.image) {
                ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
            }

            let handDetected = false;
            let currentLandmarks = null;

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                handDetected = true;
                const landmarks = results.multiHandLandmarks[0];

                drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {
                    color: '#00FF00',
                    lineWidth: 2
                });
                drawLandmarks(ctx, landmarks, {
                    color: '#FF0000',
                    lineWidth: 1,
                    radius: 2
                });

                currentLandmarks = landmarks;
            }

            ctx.restore();

            // æ›´æ–°æ‰‹åŠ¿ä¿¡æ¯
            if (handDetected) {
                gestureInfo.textContent = 'æ£€æµ‹åˆ°æ‰‹';
                gestureInfo.style.background = 'rgba(0, 255, 136, 0.6)';
            } else {
                gestureInfo.textContent = 'æœªæ£€æµ‹åˆ°æ‰‹';
                gestureInfo.style.background = 'rgba(255,107,107,0.8)';
            }

            // å¦‚æœæ­£åœ¨è¯†åˆ«ï¼Œæ‰§è¡Œè¯†åˆ«
            if (isRecognizing && handDetected && currentLandmarks) {
                const result = recognizeGesture(currentLandmarks);
                numberStatus.textContent = result.message;
                if (result.number !== -1) {
                    showNumberImage(result.number);
                }
            }
        }

        // æ˜¾ç¤ºæ•°å­—å›¾ç‰‡
        function showNumberImage(num) {
            numberImage.src = numberImageFiles[num];
            numberImage.classList.add('visible');
            numberPlaceholder.classList.add('hidden');
            numberDisplay.classList.add('active');
            numberStatus.textContent = `ğŸ”¢ ${num}`;
            numberStatus.className = 'status number';
        }

        // éšè—æ•°å­—å›¾ç‰‡
        function hideNumberImage() {
            numberImage.classList.remove('visible');
            numberPlaceholder.classList.remove('hidden');
            numberDisplay.classList.remove('active');
            numberStatus.textContent = 'è¯†åˆ«ä¸­...';
            numberStatus.className = 'status';
        }

        // è®­ç»ƒæŒ‰é’®äº‹ä»¶
        trainBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (!isCameraRunning) {
                    numberStatus.textContent = 'è¯·å…ˆå¯åŠ¨æ‘„åƒå¤´ï¼';
                    return;
                }

                // å½•åˆ¶å½“å‰æ‰‹åŠ¿æ ·æœ¬ï¼ˆå»¶è¿Ÿå½•åˆ¶ä»¥è®©ç”¨æˆ·å‡†å¤‡å¥½ï¼‰
                btn.classList.add('active');
                numberStatus.textContent = `å½•åˆ¶æ•°å­— ${btn.dataset.number} æ ·æœ¬ä¸­...`;

                setTimeout(() => {
                    // è·å–å½“å‰çš„æ‰‹åŠ¿æ•°æ®
                    hands.onResults((results) => {
                        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                            const landmarks = results.multiHandLandmarks[0];
                            // å­˜å‚¨ç‰¹å¾å‘é‡ï¼ˆè€Œä¸æ˜¯åŸå§‹åæ ‡ï¼‰
                            const sample = extractFeatures(landmarks);
                            trainingData[btn.dataset.number].push(sample);

                            // æ›´æ–°æŒ‰é’®ä¸Šçš„æ ·æœ¬è®¡æ•°
                            const countSpan = btn.querySelector('.sample-count');
                            countSpan.textContent = trainingData[btn.dataset.number].length;

                            updateTrainingStatus();
                            numberStatus.textContent = `âœ… æ•°å­— ${btn.dataset.number} æ ·æœ¬å·²å½•åˆ¶ (${trainingData[btn.dataset.number].length}ä¸ª)`;

                            // ä¿å­˜è®­ç»ƒæ•°æ®åˆ°localStorage
                            saveTrainingData();
                            console.log('æ ·æœ¬å·²ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°å­˜å‚¨');

                            setTimeout(() => {
                                btn.classList.remove('active');
                            }, 500);
                        } else {
                            numberStatus.textContent = 'âŒ æœªæ£€æµ‹åˆ°æ‰‹åŠ¿ï¼Œè¯·é‡è¯•';
                            btn.classList.remove('active');
                        }

                        // æ¢å¤æ­£å¸¸çš„onResultså¤„ç†
                        hands.onResults(onResults);
                    });
                }, 1000);
            });
        });

        // è¯†åˆ«æŒ‰é’®äº‹ä»¶
        recognizeBtn.addEventListener('mousedown', () => {
            if (!isCameraRunning) {
                numberStatus.textContent = 'è¯·å…ˆå¯åŠ¨æ‘„åƒå¤´ï¼';
                return;
            }

            const trainedCount = Object.values(trainingData).filter(data => data.length > 0).length;
            if (trainedCount === 0) {
                numberStatus.textContent = 'è¯·å…ˆè‡³å°‘å½•åˆ¶ä¸€ä¸ªæ•°å­—çš„æ‰‹åŠ¿æ ·æœ¬ï¼';
                return;
            }

            isRecognizing = true;
            recognizeBtn.classList.add('recording');
            recognizeBtn.textContent = 'ğŸ” è¯†åˆ«ä¸­...';
            hideNumberImage();
        });

        recognizeBtn.addEventListener('mouseup', () => {
            isRecognizing = false;
            recognizeBtn.classList.remove('recording');
            recognizeBtn.textContent = 'ğŸ” æŒ‰ä½è¯†åˆ«æ‰‹åŠ¿';
        });

        recognizeBtn.addEventListener('mouseleave', () => {
            if (isRecognizing) {
                isRecognizing = false;
                recognizeBtn.classList.remove('recording');
                recognizeBtn.textContent = 'ğŸ” æŒ‰ä½è¯†åˆ«æ‰‹åŠ¿';
            }
        });

        // å¯¼å‡ºè®­ç»ƒæ•°æ®æŒ‰é’®äº‹ä»¶
        const exportBtn = document.getElementById('exportBtn');
        exportBtn.addEventListener('click', () => {
            const trainedCount = Object.values(trainingData).filter(data => data.length > 0).length;
            if (trainedCount === 0) {
                alert('æ²¡æœ‰è®­ç»ƒæ•°æ®å¯å¯¼å‡ºï¼è¯·å…ˆå½•åˆ¶æ‰‹åŠ¿æ ·æœ¬ã€‚');
                return;
            }

            // ç”Ÿæˆå¯¼å‡ºä»£ç 
            const exportCode = `const PRESET_DATA = {
${Object.entries(trainingData).filter(([num, samples]) => samples.length > 0).map(([num, samples]) =>
    `    ${num}: ${JSON.stringify(samples)}`
).join(',\n')}
};`;

            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(exportCode).then(() => {
                alert('âœ… è®­ç»ƒæ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š\n1. æ‰“å¼€ index.html æ–‡ä»¶\n2. æ‰¾åˆ° PRESET_DATA = { è¿™ä¸€è¡Œ\n3. å°†å¯¼å‡ºçš„æ•°æ®æ›¿æ¢ç²˜è´´åˆ° PRESET_DATA ä¸­\n4. ä¿å­˜æ–‡ä»¶\n\nä¸‹æ¬¡æ‰“å¼€é¡µé¢å°±ä¼šè‡ªåŠ¨åŠ è½½è¿™äº›è®­ç»ƒæ•°æ®ï¼Œæ— éœ€é‡æ–°è®­ç»ƒï¼');
            }).catch(err => {
                // å¦‚æœå‰ªè´´æ¿APIå¤±è´¥ï¼Œæ˜¾ç¤ºåœ¨å¼¹çª—ä¸­
                console.error('å¤åˆ¶å¤±è´¥:', err);
                prompt('è¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹ä»£ç ï¼Œç„¶åç²˜è´´åˆ° index.html çš„ PRESET_DATA å˜é‡ä¸­ï¼š', exportCode);
            });
        });

        // æ¸…é™¤è®­ç»ƒæ•°æ®æŒ‰é’®äº‹ä»¶
        const clearBtn = document.getElementById('clearBtn');
        clearBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®­ç»ƒæ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                // æ¸…é™¤å†…å­˜ä¸­çš„è®­ç»ƒæ•°æ®
                for (let num = 0; num <= 9; num++) {
                    trainingData[num] = [];
                }

                // æ¸…é™¤localStorage
                localStorage.removeItem(STORAGE_KEY);

                // æ›´æ–°UIæ˜¾ç¤º
                trainBtns.forEach(btn => {
                    const countSpan = btn.querySelector('.sample-count');
                    countSpan.textContent = '0';
                });
                updateTrainingStatus();

                numberStatus.textContent = 'âœ… æ‰€æœ‰è®­ç»ƒæ•°æ®å·²æ¸…é™¤';
                console.log('è®­ç»ƒæ•°æ®å·²æ¸…é™¤');
            }
        });

        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 }
                });
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    canvas.width = 320;
                    canvas.height = 240;

                    const camera = new Camera(video, {
                        onFrame: async () => {
                            await hands.send({ image: video });
                        },
                        width: 640,
                        height: 480
                    });
                    camera.start();

                    isCameraRunning = true;
                    gestureInfo.textContent = 'æ£€æµ‹ä¸­...';
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'block';
                };
            } catch (error) {
                console.error('æ‘„åƒå¤´è®¿é—®å¤±è´¥:', error);
                numberStatus.textContent = 'âŒ æ— æ³•è®¿é—®æ‘„åƒå¤´: ' + error.message;
            }
        }

        // åœæ­¢æ‘„åƒå¤´
        function stopCamera() {
            const stream = video.srcObject;
            if (stream) {
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            gestureInfo.textContent = 'å·²åœæ­¢';
            gestureInfo.style.background = 'rgba(0,0,0,0.8)';
            isCameraRunning = false;

            startBtn.style.display = 'block';
            stopBtn.style.display = 'none';
        }

        // äº‹ä»¶ç›‘å¬
        startBtn.addEventListener('click', startCamera);
        stopBtn.addEventListener('click', stopCamera);
        window.addEventListener('beforeunload', stopCamera);
    </script>
</body>
</html>
